# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

This directory contains 70+ Datagrok plugins. Each plugin is a self-contained TypeScript plugin that extends
the Datagrok data analytics platform with viewers, connectors, scientific tools, and more.

## Build Commands

Every package follows the same build pattern. Run from within a package directory:

```bash
npm install                # Install dependencies
npm run build              # Full build: grok api && grok check --soft && webpack
npm run lint               # ESLint check: eslint "src/**/*.ts"
npm run lint-fix           # ESLint auto-fix
npm run test               # Run tests: grok test (requires running Datagrok instance)
npm run test-dev           # Run tests against dev server
npm run link-all           # Link local datagrok-api and @datagrok-libraries/*
```

Publishing:

```
grok publish
```

Build with all local dependencies (available in some packages):

```bash
npm run build-all          # Builds js-api → libraries → package in dependency order
```

Testing:

```bash
grok test --test "TestName"          # Run specific test by name prefix
grok test --category "CategoryName"  # Run tests in a category
grok test --gui                      # Run with visible browser for debugging
grok test --gui --debug              # With breakpoints
```

## Package Structure

A package is a versionable unit of content distribution. Beyond TypeScript source, packages can bundle
scripts, queries, connections, Docker containers, databases, and static files — all recognized by the
platform automatically.

```
PackageName/
  src/
    package.ts          # Entry point — registers functions via //name: comments
    package-test.ts     # Test entry — exports tests array for grok test
    package.g.ts        # AUTO-GENERATED by grok api (do not edit)
    package-api.ts      # AUTO-GENERATED typed wrappers (do not edit)
    detectors.ts        # Semantic type detectors (loaded separately by platform)
    tests/              # Test files using @datagrok-libraries/test
  scripts/              # Python/R/Julia/Octave/JS scripts (see below)
  queries/              # SQL query files (see below)
  connections/          # Data connection JSON definitions (see below)
  dockerfiles/          # Docker containers managed by platform (see below)
  databases/            # Package-owned PostgreSQL schemas with migrations (see below)
  files/                # Static assets, templates, demo data
  tables/               # Demo/test CSV/Excel files distributed with package
  environments/         # Execution environment definitions for scripts
  css/                  # Custom stylesheets
  webpack.config.js     # Two entry points: package.ts and package-test.ts
  tsconfig.json         # ES2020 target, strict mode, decorators enabled
  .eslintrc.json        # Google style, 120 char lines, 2-space indent
  package.json
```

### Scripts (`scripts/`)

Server-side computation scripts in Python, R, Julia, Octave, or JS. Each script file is annotated with
metadata comments and automatically registered as a platform function.

```python
#name: Descriptors
#language: python
#input: dataframe df
#input: column smiles {type: chemical/smiles}
#output: dataframe result
def descriptors(df, smiles):
    ...
```

Scripts execute in managed environments on the server. See packages like **Chem**, **Dendrogram**, **NLP**
for examples.

### Queries (`queries/`)

SQL queries stored as `.sql` files (one or more queries per file). Each query has metadata comments and
references a connection by name. Parameterized queries use `@paramName` syntax.

```sql
--name: ProteinClassification
--connection: Chembl
--input: string target = "CHEMBL301"
SELECT * FROM protein_classification WHERE chembl_id = @target
--end
```

A `.js` file with the same name as the query provides post-processing; a `.layout` file applies a table
layout to results. See **Chembl**, **UsageAnalysis**, **Samples** for examples.

### Connections (`connections/`)

JSON files defining data connections (databases, file shares, APIs). Credentials support environment
variable substitution via `${VAR_NAME}`. One connection per file.

```json
{
  "#type": "DataConnection",
  "name": "MyDb",
  "parameters": { "server": "db.example.com", "port": 5432, "db": "mydb" },
  "credentials": { "parameters": { "login": "${DB_LOGIN}", "password": "${DB_PASSWORD}" } },
  "dataSource": "Postgres"
}
```

See **Chembl**, **Samples**, **DBTests** for examples.

### Docker Containers (`dockerfiles/`)

Each subdirectory is a container managed by the platform. Contains a `Dockerfile` and an optional
`container.json` for resource limits.

```
dockerfiles/
  my-service/
    Dockerfile
    container.json       # {"cpu": 0.5, "memory": 1024, "on_demand": true, "gpu": 0}
    requirements.in      # Python dependencies (if applicable)
```

Access from TypeScript via `grok.dapi.docker.dockerContainers.fetchProxy(containerId, '/endpoint', opts)`.
See **Chem**, **Docking**, **Boltz1**, **Reinvent4** for examples.

### Databases (`databases/`)

Package-owned PostgreSQL schemas with forward-only migrations. Each subdirectory becomes a database schema;
SQL files are applied in lexicographic order (`0000_init.sql`, `0001_add_column.sql`, ...).

```sql
-- databases/myschema/0000_init.sql
CREATE TABLE myschema.items (id SERIAL PRIMARY KEY, name TEXT NOT NULL);
GRANT ALL ON TABLE myschema.items TO :LOGIN;
```

Access the data via package queries referencing the schema name as the connection. See **Biologics**,
**MolTrack**, **HitTriage** for examples.

### Files and Tables (`files/`, `tables/`)

Static assets distributed with the package. Access at runtime:

```typescript
// Read from files/ folder
const text = await _package.files.readAsText('templates/config.json');
const bytes = await _package.files.readAsBytes('data.bin');

// List files
const items = await _package.files.list('templates/', true);

// Load a table via HTTP
const df = await grok.data.loadTable(`${_package.webRoot}tables/demo.csv`);
```

Files are browseable in the platform under `Files | App Data | <PackageName>`.

## Function Registration

Functions are declared via JSDoc-style metadata comments (not TypeScript decorators), then processed by `grok api` to
generate `package.g.ts` and `package-api.ts`:

```typescript
//name: myViewer
//description: Custom scatter plot
//input: dataframe df
//output: viewer result
//meta.role: panel
export function myViewer(df: DG.DataFrame): DG.Viewer {
}
```

The `grok api` command parses these comments and generates typed wrappers. The `grok check` command validates them.

## Webpack Externals

These are provided by the platform at runtime and must NOT be bundled:

- `datagrok-api/dg`, `datagrok-api/grok`, `datagrok-api/ui`
- `rxjs`, `rxjs/operators`, `cash-dom`, `dayjs`, `wu`
- `openchemlib/full.js`

## Key API Imports

Packages import three namespaces from `datagrok-api`:

- **`grok`** — shell, functions, events, data operations, server API
- **`ui`** — UI components: dialogs, inputs, menus, viewers
- **`DG`** (from `datagrok-api/dg`) — all types, constants, classes (DataFrame, Column, Viewer, etc.)

## Linking for Local Development

When modifying `js-api` or `@datagrok-libraries/*` alongside a package:

```bash
# Recommended: from within the package directory
grok link              # Auto-discovers and links all local dependencies
grok link --unlink     # Revert to npm versioned dependencies

# Or use the package script
npm run link-all       # Links specific dependencies listed in package.json
```

Always link all dependencies in a single command. When linking to local js-api, also link all libraries to local js-api.

## Naming Conventions

- Package folder: **PascalCase** (`PowerGrid`, `BiostructureViewer`)
- Package name in package.json: **kebab-case with scope** (`@datagrok/power-grid`)
- File names: **kebab-case** (`compare-columns.ts`)

## Main Packages

- **Chem** — main plugin for the cheminformatics (small molecules) support 
- **Bio** — sequences, peptides 
- **ApiSamples** — API usage examples in `scripts/`
- **ApiTests** — comprehensive API test coverage
- **DbTests** — database provider connectivity test (30+ providers)
- **Charts** — advanced charts (chord, globe, radar, sankey, sunburst, surface plot, timelines)
- **ChatGPT** — AI support
- **Curves** - dose-response curves
- **Compute** - rich environment for simulations
- **Peptides** - peptide SAR
- **PowerPack** - useful platform enhancement
- **PowerGrid** - grid enhancements: many cell renderers, sparklines, forms, pinned columns
