# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

PowerGrid is a Datagrok plugin that extends the platform's grid (spreadsheet) with custom cell renderers,
sparkline summary columns, a forms viewer, pinned columns, and WebGPU-accelerated scatter plot rendering.

## Architecture

### Entry Points

- **`src/package.ts`** — Main entry. The `PackageFunctions` class registers all cell renderers, viewers, and actions
  via `@grok.decorators.func()` decorators. The `_autoPowerGrid()` autostart function initializes pinned columns,
  registers the scatter plot renderer, subscribes to grid events for sparkline column maintenance, and acquires the
  WebGPU device.
- **`src/package-test.ts`** — Test entry. Imports test files and exports the `test` function used by `grok test`.
- **`src/package.g.ts`** / **`src/package-api.ts`** — Auto-generated by `grok api`. Do not edit.

### Cell Renderers (`src/cell-types/`)

Simple renderers that extend `DG.GridCellRenderer`. Each must implement `render(g, x, y, w, h, gridCell, cellStyle)` for
canvas drawing. Registered with `meta.role: 'cellRenderer'` and a unique `meta.cellType`.

| File                            | Cell Type                    | Purpose                                                   |
|---------------------------------|------------------------------|-----------------------------------------------------------|
| `bar-cell-renderer.ts`          | `bar`                        | Horizontal bar for a single numeric column                |
| `stars-cell-renderer.ts`        | `Stars`                      | Editing rating (stars)                                    |
| `binary-image-cell-renderer.ts` | `BinaryImage`                | Renders bytes columns as images                           |
| `image-cell-renderer.ts`        | `ImageUrl`                   | Renders URL-referenced images with LRU cache              |
| `hyperlink-cell-renderer.ts`    | `Hyperlink`                  | Clickable URL links                                       |
| `multi-choice-cell-renderer.ts` | `MultiChoice`                | Checkbox multi-select (uses `column.meta.choices`)        |
| `tags-cell-renderer.ts`         | `Tags`                       | Tag/badge rendering with auto-splitting on `,`            |
| `test-cell-renderer.ts`         | `testUnitsKg`/`testUnitsTon` | Demo renderers using `columnTags` for tag-based detection |

### Sparklines (`src/sparklines/`)

Multi-column summary visualizations rendered in a single cell. All sparkline renderers are "virtual" grid columns (no
backing data column). They share settings and utilities defined in `shared.ts`.

- **`shared.ts`** — Core types: `SummarySettingsBase` (column names, normalization, color coding), `SparklineType`
  enum, `NormalizationType` (Row/Column/Global), `ScaleSettings`, `getSettingsBase()` for reading/initializing settings
  from `gridColumn.settings[cellType]`.
- **`sparklines-lines.ts`** — Line sparklines with optional area fill and markers
- **`bar-chart.ts`** — Vertical bar chart per row
- **`piechart.ts`** — Pie/donut charts
- **`radar-chart.ts`** — Radar/spider charts
- **`scatter-plot.ts`** — Mini scatter plots (registered in autostart, not via decorator)

Settings are persisted in `gridColumn.settings[cellType]` and rendered as a settings panel
via `renderSettings(gridColumn)`.

### Forms (`src/forms/`)

`FormCellRenderer` renders multiple columns as a compact form in a single cell. Uses a scene
graph (`Scene`, `Element`, `LabelElement`, `MarkerElement`, `GridCellElement`) for compositional layout. Auto-switches
between 1 and 2 column layouts based on available width.

### WebGPU (`src/webgpu/`)

GPU-accelerated scatter plot rendering. `scWebGPURender()` and `scWebGPUPointHitTest()` are registered as platform
functions called by the scatter plot viewer when WebGPU is available. `WebGPUCache` manages GPU buffers. Falls back
gracefully when unavailable or on error (tracked via `gpuErrorCounter`).

### Pinned Columns

Provided by `@datagrok-libraries/gridext`. Registered in autostart via `PinnedUtils.registerPinnedColumns()`.
The `addPinnedColumn()` function is exposed as a package function.

### Key Dependencies

- **`@datagrok-libraries/gridext`** — Pinned column implementation
- **`@datagrok-libraries/utils`** — `FormsViewer` (the standalone forms viewer)
- **`@datagrok-libraries/statistics`** — Statistical computations
- **`@datagrok-libraries/math`** — WebGPU device acquisition (devDependency, used at runtime via webpack)

### Tests (`src/tests/`)

- `pinned-column-tests.ts` — Pinned column functionality
- `webgpu-tests.ts` — WebGPU rendering benchmarks

## Key Patterns

- Cell renderers are registered via decorators in `PackageFunctions` with `meta.role: 'cellRenderer'` and
  a `meta.cellType` identifier. Some renderers (like `BinaryImageCellRenderer`) are registered in `package.g.ts` using
  JSDoc comments instead.
- Sparkline columns are "virtual" (`meta.virtual: 'true'`) — they have no backing DataFrame column and store their
  configuration (which columns to summarize) in `gridColumn.settings`.
- The autostart function subscribes to `onColumnsRemoved` and `onColumnNameChanged` events to keep sparkline settings in
  sync when source columns are renamed or deleted.
- Image cell renderer uses a global `Map<string, HTMLImageElement>` cache keyed by URL.
